<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign Up</title>
  <style>
    body { background:#D6E6F2; height:100vh; margin:0; font-family:sans-serif; display:flex; align-items:center; justify-content:center; }
    .container{ background:white; padding:2rem; border-radius:10px; width:350px; box-shadow:0 2px 16px rgba(0,0,0,.15); text-align:center; }
    input{ width:100%; padding:11px; margin-top:14px; border-radius:6px; border:1px solid #ccc; }
    button{ width:100%; padding:12px; margin-top:14px; background:#2563EB; color:#fff; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    button:hover{background:#1e4fc0;}
    #messageBox{margin-top:10px;font-size:14px;}
  </style>
</head>
<body>
<div class="container">
  <h2>Sign Up</h2>
  <input type="text" id="name" placeholder="Name"/>
  <input type="text" id="mobile" placeholder="Mobile Number (e.g., +919876543210)"/>

  <div id="recaptcha-container"></div>
  <button id="sendOtpBtn">Send OTP</button>

  <input id="otp" type="text" placeholder="Enter OTP" style="display:none">
  <input id="password" type="password" placeholder="Create Password" style="display:none">
  <button id="verifyOtpBtn" style="display:none">Verify & Complete Sign Up</button>

  <div id="messageBox"></div>
  <p>Already have an account? <a href="login.html">Login</a></p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB3bgWB0qZ2QnH2ZK5mql2S49E_ixZjInQ",
    authDomain: "printerscheduler-e9e74.firebaseapp.com",
    projectId: "printerscheduler-e9e74",
    storageBucket: "printerscheduler-e9e74.appspot.com",
    messagingSenderId: "11551500034",
    appId: "1:11551500034:web:ba2f8685038c06dbad041b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let confirmationResult = null;

  const showMessage = (msg, color="red") => {
    const m=document.getElementById("messageBox");
    m.style.color=color; m.innerText=msg;
  };

  // render captcha once
  const recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container',{size:'invisible'});
  recaptchaVerifier.render();

  document.getElementById("sendOtpBtn").onclick = async() => {
    const name=document.getElementById("name").value.trim();
    const mobile=document.getElementById("mobile").value.trim();
    if(!name||!mobile){ return showMessage("Enter name & mobile number"); }
    try{
      confirmationResult = await signInWithPhoneNumber(auth, mobile, recaptchaVerifier);
      showMessage("OTP sent!", "green");
      document.getElementById("otp").style.display="block";
      document.getElementById("password").style.display="block";
      document.getElementById("verifyOtpBtn").style.display="block";
    }catch(e){
      showMessage("Failed: "+e.message);
    }
  };

  document.getElementById("verifyOtpBtn").onclick = async()=>{
    const otp=document.getElementById("otp").value.trim();
    const password=document.getElementById("password").value.trim();
    const name=document.getElementById("name").value.trim();
    const mobile=document.getElementById("mobile").value.trim();

    if(!confirmationResult){
      return showMessage("Send OTP first.");
    }
    if(!otp||!password){
      return showMessage("Enter OTP & password");
    }

    try{
      const res = await confirmationResult.confirm(otp);
      await setDoc(doc(db,"users",res.user.uid), {name,mobile,password});

      // Save to pre-fill login
      localStorage.setItem("lastMobile", mobile);

      showMessage("Signup successful. Redirecting...", "green");
      setTimeout(()=>window.location.href="login.html", 1100);
    }catch(err){
      showMessage("Incorrect OTP. Try again.");
    }
  };
</script>
</body>
</html>
